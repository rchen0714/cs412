<!-- 
File: home.html
Author: Ruby Chen (rc071404@bu.edu), 7/14/2004
Description: This is the template for the home page of the terrier_study app.
It contains a welcome message, filter form, and a map showing study spots.
-->

{% extends "terrier_study/base.html" %}
{% load static %}

{% block content %}

<div class="page-wrapper">

    <h3 class="subtitle"> 
        Welcome to TerrierStudy!  A campus navigation app designed to help 
        Boston University students easily discover and locate study 
        spots across BU campus.
    </h3>

    <!-- Filter Form -->
    <div class="filter-section">
        {% include "terrier_study/filter_form.html" with form_action="home" %}
    </div>


    <!-- map -->
    <div id="map"></div>

</div>

<!-- google map init script used this as reference:  -->
<!-- https://apidog.com/blog/how-to-integrate-google-http-apidog-com-blog-how-to-integrate-google-maps-api-maps-api/-->

<script
    src="https://maps.googleapis.com/maps/api/js?key={{ google_key }}&callback=initMap" async defer>
</script>

<script>
function initMap() {
    // Initialize the Google Map centered on BU
    const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: 42.3505, lng: -71.1054 }
    });

    // Pass current filter query parameters to the API
    const params = new URLSearchParams(window.location.search);

    //Fetch filtered buildings from Django's API and regular 
    //Fetch data from the API endpoint cmds
    fetch("/rc071404/terrier_study/api/buildings/?" + params.toString())
        .then(response => response.json())
        .then(data => {
            const buildings = data.results ?? data;

            //error handling for if long or lat dont exist 
            buildings.forEach(b => {
                if (!b.latitude || !b.longitude) return;

                // Create a marker if the building exists 
                const marker = new google.maps.Marker({
                    position: { lat: b.latitude, lng: b.longitude },
                    map: map,
                    title: b.name
                });

                // When clicking a marker, go to that building's detail page
                marker.addListener("click", () => {
                    window.location.href = `/rc071404/terrier_study/buildings/${b.id}/`;
                });
            });
        })
        //error handling for fetch
        .catch(err => console.error("Error loading buildings:", err));
}
</script>

{% endblock %}